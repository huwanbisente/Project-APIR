<!DOCTYPE html>
<html class="scroll-smooth">

<head>
  <base target="_top">
  <!-- Tailwind CSS with Dark Mode support -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.5s ease-out',
            'shimmer': 'shimmer 2s infinite',
          },
          keyframes: {
            fadeInUp: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            shimmer: {
              '100%': { transform: 'translateX(100%)' },
            }
          }
        }
      }
    }
  </script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    /* Base Backgrounds */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
      background-image:
        radial-gradient(at 0% 0%, hsla(215, 96%, 93%, 1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, hsla(245, 96%, 93%, 1) 0px, transparent 50%),
        radial-gradient(at 100% 100%, hsla(205, 96%, 93%, 1) 0px, transparent 50%),
        radial-gradient(at 0% 100%, hsla(270, 96%, 96%, 1) 0px, transparent 50%);
      min-height: 100vh;
      transition: background-color 0.4s, color 0.4s;
      background-size: 150% 150%;
      background-attachment: fixed;
    }

    /* Light Mode - Snowy Tundra (Refined) */
    .bg-gradient-light {
      /* Already handled by body default */
      color: #1e293b;
    }

    /* Dark Mode - Lighter Aurora */
    body.dark {
      background-color: #0f172a !important;
      /* Slate-900 (Not Black) */
      color: #e2e8f0;
      background-image:
        /* Green Aurora Top Left */
        radial-gradient(at 0% 0%, hsla(165, 80%, 25%, 0.35) 0px, transparent 60%),
        /* Purple Aurora Top Right */
        radial-gradient(at 100% 0%, hsla(260, 80%, 30%, 0.3) 0px, transparent 60%),
        /* Blue/Teal Glow Bottom */
        radial-gradient(at 50% 100%, hsla(220, 90%, 25%, 0.3) 0px, transparent 60%) !important;
    }

    /* Glass Panel - Light */
    .glass-panel {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    }

    /* Glass Panel - Dark (Lighter, Frosted Look) */
    .dark .glass-panel {
      background: rgba(255, 255, 255, 0.08);
      /* White tint instead of black */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      /* Crisper border */
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    /* Inputs - Light */
    .glass-input {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(203, 213, 225, 1);
      color: #1e293b;
    }

    /* Inputs - Dark */
    .dark .glass-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f8fafc;
    }

    .glass-input:focus {
      background: rgba(255, 255, 255, 1);
      border-color: #6366f1;
      outline: none;
    }

    .dark .glass-input:focus {
      background: rgba(30, 41, 59, 0.9);
      border-color: #818cf8;
    }

    /* Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.5);
      border-radius: 10px;
    }

    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body class="p-4 md:p-8 flex flex-col items-center min-h-screen transition-colors duration-300 bg-gradient-light"
  :class="{ 'dark': isDark }" x-data="app()" x-cloak>

  <!-- Header & Stats -->
  <div
    class="w-full max-w-7xl mb-6 md:mb-10 flex flex-col md:flex-row justify-between items-center md:items-end gap-6 md:gap-0">
    <div class="text-center md:text-left">
      <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight mb-2 text-slate-800 dark:text-white">
        Invoice AI <span class="text-indigo-600 dark:text-indigo-400">Hub</span>
      </h1>
      <p class="text-slate-500 dark:text-slate-400 font-medium">Intelligent Extraction & Processing Dashboard</p>
    </div>

    <div class="flex items-center gap-4">
      <!-- User Menu -->
      <div class="hidden md:flex flex-col text-right mr-2" x-show="userEmail">
        <span class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">Logged in as</span>
        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200" x-text="userEmail"></span>
      </div>

      <button x-show="userEmail" @click="logout()" title="Sign Out"
        class="glass-panel p-3 rounded-full hover:bg-slate-800 hover:text-white transition-all text-slate-600 dark:text-slate-400">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
      </button>

      <!-- Theme Toggle -->
      <button @click="toggleTheme()"
        class="glass-panel p-3 rounded-full hover:bg-white/50 dark:hover:bg-slate-700/50 transition-colors text-slate-600 dark:text-yellow-400"
        aria-label="Toggle Dark Mode">
        <svg x-show="!isDark" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
        <svg x-show="isDark" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
          </path>
        </svg>
      </button>

      <!-- Mini Stats -->
      <div class="flex gap-3 md:gap-4">
        <div class="glass-panel rounded-xl px-4 py-2 md:px-5 md:py-3 text-center">
          <p class="text-[10px] md:text-xs text-slate-500 dark:text-slate-400 uppercase font-black tracking-wider">
            Processed</p>
          <p class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white" x-text="stats.processedCount">0</p>
        </div>
        <div class="glass-panel rounded-xl px-4 py-2 md:px-5 md:py-3 text-center">
          <p class="text-[10px] md:text-xs text-slate-500 dark:text-slate-400 uppercase font-black tracking-wider">Value
          </p>
          <p class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400"
            x-text="'$' + stats.totalValue.toFixed(2)">$0.00</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Grid -->
  <main class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 mb-8">

    <!-- LEFT COL: Upload (Sticky on Desktop) -->
    <div class="lg:col-span-4 lg:sticky lg:top-8 z-10 flex flex-col">
      <div
        class="glass-panel rounded-2xl p-6 md:p-8 shadow-xl relative overflow-hidden transition-all duration-300 h-full flex flex-col">
        <!-- Decorator -->
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl pointer-events-none">
        </div>

        <h2 class="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
          </svg>
          Upload Source
        </h2>

        <div id="drop-zone"
          class="relative group border-2 border-dashed border-indigo-300 dark:border-indigo-700/50 rounded-xl p-6 text-center hover:border-indigo-500 dark:hover:border-indigo-500 hover:bg-white/40 dark:hover:bg-white/5 transition-all cursor-pointer flex flex-col items-center justify-center min-h-[260px] bg-white/20 dark:bg-slate-800/20 flex-1">
          <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
            accept=".pdf,image/*" @change="handleFileSelect" multiple>


          <div class="space-y-4 transition-opacity duration-300">

            <!-- Default State -->
            <div x-show="!isLoading && queue.length === 0">
              <div
                class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition-transform shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
              </div>
              <div class="mt-4">
                <p class="text-lg font-bold text-slate-700 dark:text-slate-200">Drag & Drop Invoice</p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">PDF, JPG, PNG up to 10MB</p>
              </div>
              <div class="pt-4">
                <span
                  class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 text-xs font-bold px-4 py-2 rounded-full border border-indigo-100 dark:border-indigo-800">Browse
                  Files</span>
              </div>
            </div>

            <!-- Queue State with Manual Trigger -->
            <div x-show="!isLoading && queue.length > 0" class="space-y-4">
              <div
                class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 font-bold text-lg"
                x-text="queue.length"></div>
              <div class="space-y-1">
                <p class="font-bold text-slate-700 dark:text-slate-200">Files Queued</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">Ready for Extraction</p>
              </div>


            </div>

          </div>

          <!-- Loader -->
          <div x-show="isLoading" class="text-center" style="display: none;">
            <div class="relative w-16 h-16 mx-auto mb-4">
              <div class="absolute inset-0 border-4 border-slate-200 dark:border-slate-700 rounded-full"></div>
              <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin">
              </div>
            </div>
            <p class="text-indigo-600 dark:text-indigo-400 font-bold animate-pulse text-lg">Analyzing...</p>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Extracting structured data</p>
            <p class="text-xs text-slate-400 mt-2 font-mono" x-text="processingFile"></p>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-200/50 dark:border-white/10">
          <h3 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-4">Capabilities
          </h3>
          <ul class="space-y-3">
            <li class="flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-300">
              <div
                class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <span>Complex Table Extraction</span>
            </li>
            <li class="flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-300">
              <div
                class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <span>Handwritten Text Support</span>
            </li>
            <li class="flex items-center gap-3 text-sm font-medium text-slate-600 dark:text-slate-300">
              <div
                class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <span>Multi-page Processing</span>
            </li>
          </ul>
        </div>
      </div>

      <!-- Start Button (Outside Drop Zone) -->
      <div x-show="!isLoading && queue.length > 0" class="mt-6 animate-fade-in-up">
        <button @click.stop.prevent="startProcessing()"
          class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-black text-lg py-4 px-6 rounded-2xl shadow-xl shadow-indigo-500/20 hover:shadow-indigo-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center gap-3 group">
          <span>Start Batch Processing</span>
          <svg class="w-6 h-6 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </button>
        <p class="text-center text-[10px] text-slate-400 mt-2">Will process all queued files sequentially</p>
      </div>
    </div>

    <!-- RIGHT COL: Context Aware (Dashboard or Review) -->
    <div class="lg:col-span-8 flex flex-col min-h-[600px] animate-fade-in-up">

      <!-- DASHBOARD VIEW -->
      <div class="flex flex-col gap-6 h-full">

        <!-- System Status -->
        <div class="glass-panel rounded-2xl p-6 md:p-8 shadow-lg">
          <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <h2 class="text-xl font-bold text-slate-800 dark:text-white">System Status</h2>
            <div
              class="flex items-center gap-2 bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full border border-green-200 dark:border-green-800">
              <span class="flex h-2.5 w-2.5 relative">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
              </span>
              <span
                class="text-xs font-bold text-green-700 dark:text-green-400 uppercase tracking-wide">Operational</span>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <!-- Stat Cards -->
            <div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-white/60 dark:border-slate-700">
              <div class="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-bold tracking-widest mb-2">AI
                Model</div>
              <div class="text-indigo-700 dark:text-indigo-400 font-extrabold text-lg flex items-center gap-2">
                <span class="text-2xl">ðŸ¦™</span> Llama 3.3
              </div>
              <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full mt-4 overflow-hidden">
                <div class="bg-indigo-500 h-full w-[98%]"></div>
              </div>
            </div>

            <div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-white/60 dark:border-slate-700">
              <div class="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-bold tracking-widest mb-2">
                Latency</div>
              <div class="text-slate-800 dark:text-slate-200 font-extrabold text-lg flex items-center gap-2">
                <svg class="w-5 h-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                ~1.2s <span class="text-xs font-normal text-slate-400">avg</span>
              </div>
              <p class="text-[10px] text-slate-400 mt-4 leading-tight">Optimized for high-throughput batch processing.
              </p>
            </div>

            <div class="bg-white/50 dark:bg-slate-800/50 p-5 rounded-xl border border-white/60 dark:border-slate-700">
              <div class="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-bold tracking-widest mb-2">
                Environment</div>
              <div class="text-slate-800 dark:text-slate-200 font-extrabold text-lg flex items-center gap-2">
                <span class="text-blue-500 text-xl">â€¢</span> Production
              </div>
              <p class="text-[10px] text-slate-400 mt-4 font-mono">v1.2.0-stable</p>
            </div>
          </div>
        </div>

        <!-- Visualization -->
        <div class="glass-panel rounded-2xl p-8 shadow-lg flex-1 flex flex-col relative overflow-hidden">
          <div class="z-10 relative">
            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Pipeline Architecture</h2>
            <p class="text-sm font-medium text-slate-500 dark:text-slate-400 max-w-lg leading-relaxed">
              Data flows securely through our ETL pipeline: scanned documents are ingested, processed by Llama 3.3 for
              structure, and exported directly to your financial system.
            </p>
          </div>

          <!-- Diagram -->
          <div
            class="mt-12 flex flex-col md:flex-row items-center justify-between px-4 md:px-12 relative z-10 gap-8 md:gap-0">
            <!-- Step 1 -->
            <div class="text-center group w-full md:w-auto">
              <div
                class="w-20 h-20 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 flex items-center justify-center mb-4 mx-auto transition-all group-hover:-translate-y-2">
                <svg class="w-10 h-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
              </div>
              <p class="text-sm font-bold text-slate-700 dark:text-slate-300">PDF Ingestion</p>
            </div>

            <!-- Connectors -->
            <div
              class="hidden md:block flex-1 h-0.5 bg-slate-200 dark:bg-slate-700 mx-4 relative overflow-hidden rounded-full">
              <div class="absolute inset-0 bg-indigo-500 w-1/2 animate-[shimmer_2.5s_infinite]"></div>
            </div>
            <!-- Mobile Arrow -->
            <div class="md:hidden text-slate-300 dark:text-slate-600">â†“</div>

            <!-- Step 2 -->
            <div class="text-center group w-full md:w-auto">
              <div
                class="w-20 h-20 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 flex items-center justify-center mb-4 mx-auto transition-all group-hover:-translate-y-2">
                <svg class="w-10 h-10 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
              </div>
              <p class="text-sm font-bold text-slate-700 dark:text-slate-300">Llama Extract</p>
            </div>

            <!-- Connectors -->
            <div
              class="hidden md:block flex-1 h-0.5 bg-slate-200 dark:bg-slate-700 mx-4 relative overflow-hidden rounded-full">
              <div class="absolute inset-0 bg-indigo-500 w-1/2 animate-[shimmer_2.5s_infinite] delay-100"></div>
            </div>
            <!-- Mobile Arrow -->
            <div class="md:hidden text-slate-300 dark:text-slate-600">â†“</div>

            <!-- Step 3 -->
            <div class="text-center group w-full md:w-auto">
              <div
                class="w-20 h-20 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 flex items-center justify-center mb-4 mx-auto transition-all group-hover:-translate-y-2">
                <svg class="w-10 h-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <p class="text-sm font-bold text-slate-700 dark:text-slate-300">Sheet Export</p>
            </div>
          </div>

          <!-- Background Blurs -->
          <div
            class="absolute bottom-[-30%] left-[-10%] w-64 h-64 bg-purple-400/20 rounded-full blur-3xl pointer-events-none">
          </div>
          <div
            class="absolute top-[-30%] right-[-10%] w-64 h-64 bg-blue-400/20 rounded-full blur-3xl pointer-events-none">
          </div>
        </div>
      </div>


    </div>

  </main>

  <!-- FULL WIDTH BOTTOM: Recent History -->
  <div class="w-full max-w-7xl">
    <h3 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3 px-1">Session
      History</h3>
    <div class="glass-panel rounded-xl overflow-hidden shadow-lg border-opacity-50">
      <div class="overflow-x-auto custom-scrollbar">
        <table class="w-full text-left text-sm text-slate-600 dark:text-slate-400 min-w-[600px]">
          <thead
            class="bg-white/50 dark:bg-slate-800/50 text-slate-800 dark:text-slate-200 font-bold border-b border-slate-200 dark:border-slate-700">
            <tr>
              <th class="px-6 py-4">Time</th>
              <th class="px-6 py-4">Vendor</th>
              <th class="px-6 py-4">Total</th>
              <th class="px-6 py-4">Items</th>
              <th class="px-6 py-4 text-right">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/50 dark:divide-slate-700/50 bg-white/20 dark:bg-slate-800/20">
            <!-- LIMIT TO 5 UPLOADS -->
            <template x-for="log in history.slice(0, 5)" :key="log.id">
              <tr class="hover:bg-white/40 dark:hover:bg-slate-700/30 transition-colors">
                <td class="px-6 py-3 font-mono text-xs" x-text="log.time"></td>
                <td class="px-6 py-3 font-bold text-slate-900 dark:text-white" x-text="log.vendor"></td>
                <td class="px-6 py-3 font-medium text-slate-700 dark:text-slate-300" x-text="log.total"></td>
                <td class="px-6 py-3" x-text="log.itemsCount + ' items'"></td>
                <td class="px-6 py-3 text-right">
                  <span
                    class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide border border-green-200 dark:border-green-800">SAVED</span>
                </td>
              </tr>
            </template>
            <tr x-show="history.length === 0">
              <td colspan="5" class="px-6 py-8 text-center text-slate-400 dark:text-slate-500 font-medium">
                No history in this session.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CSV Output Table -->
  <div class="w-full max-w-7xl mt-8 mb-20" x-show="csvResults.length > 0">
    <div class="flex justify-between items-end mb-3 px-1">
      <h3 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Extraction Results
        (CSV Format)</h3>
      <div class="flex gap-4">
        <button @click="downloadCSV()"
          class="glass-panel px-4 py-2 rounded-lg text-xs font-bold text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
            </path>
          </svg>
          Download CSV
        </button>
        <button @click="clearData()"
          class="glass-panel px-4 py-2 rounded-lg text-xs font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
            </path>
          </svg>
          Reset Workspace
        </button>
      </div>
    </div>
    <div class="glass-panel rounded-xl overflow-hidden shadow-lg border-opacity-50">
      <div class="overflow-x-auto custom-scrollbar max-h-[500px]">
        <table class="w-full text-left text-xs text-slate-600 dark:text-slate-400 whitespace-nowrap">
          <thead
            class="bg-indigo-50 dark:bg-slate-800 text-indigo-900 dark:text-indigo-300 font-bold border-b border-indigo-100 dark:border-slate-700 sticky top-0">
            <tr>
              <th class="px-4 py-3">Vendor</th>
              <th class="px-4 py-3">Invoice #</th>
              <th class="px-4 py-3">Date</th>
              <th class="px-4 py-3">Due Date</th>
              <th class="px-4 py-3 text-right">Tax</th>
              <th class="px-4 py-3 text-right">Total</th>
              <th class="px-4 py-3">Curr</th>
              <th class="px-4 py-3 bg-indigo-100/50 dark:bg-slate-700/50">Item Description</th>
              <th class="px-4 py-3 text-center bg-indigo-100/50 dark:bg-slate-700/50">Qty</th>
              <th class="px-4 py-3 text-right bg-indigo-100/50 dark:bg-slate-700/50">Unit Price</th>
              <th class="px-4 py-3 text-right bg-indigo-100/50 dark:bg-slate-700/50">Amount</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/50 dark:divide-slate-700/50 bg-white/20 dark:bg-slate-800/20">
            <!-- LIMIT TO 10 ROWS -->
            <template x-for="(row, idx) in csvResults.slice(0, 10)" :key="idx">
              <tr class="hover:bg-white/40 dark:hover:bg-slate-700/30 transition-colors">
                <td class="px-4 py-2 font-bold" x-text="row.vendor"></td>
                <td class="px-4 py-2" x-text="row.inv_num"></td>
                <td class="px-4 py-2" x-text="row.date"></td>
                <td class="px-4 py-2" x-text="row.due"></td>
                <td class="px-4 py-2 text-right" x-text="row.tax"></td>
                <td class="px-4 py-2 text-right" x-text="row.total"></td>
                <td class="px-4 py-2" x-text="row.curr"></td>
                <td class="px-4 py-2 bg-indigo-50/30 dark:bg-slate-700/30" x-text="row.description"></td>
                <td class="px-4 py-2 text-center bg-indigo-50/30 dark:bg-slate-700/30" x-text="row.quantity"></td>
                <td class="px-4 py-2 text-right bg-indigo-50/30 dark:bg-slate-700/30" x-text="row.unit_price"></td>
                <td
                  class="px-4 py-2 text-right bg-indigo-50/30 dark:bg-slate-700/30 font-medium text-slate-900 dark:text-slate-200"
                  x-text="row.amount"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div x-show="!isLoggedIn" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm"
    x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100">
    <div
      class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700 relative overflow-hidden">
      <!-- Background Decorator -->
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl pointer-events-none">
      </div>

      <div class="text-center mb-8 relative z-10">
        <h1 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-2">Welcome Back</h1>
        <p class="text-slate-500 dark:text-slate-400">Sign in to your Invoice AI Workspace</p>
      </div>

      <form @submit.prevent="login()" class="space-y-6 relative z-10">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address</label>
          <input type="email" x-model="loginForm.email" required placeholder="user@example.com"
            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white/50 dark:bg-slate-700/50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 dark:text-white transition-all">
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
          <input type="password" x-model="loginForm.password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white/50 dark:bg-slate-700/50 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 dark:text-white transition-all">
        </div>

        <button type="submit" :disabled="isLoggingIn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition-all transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
          <svg x-show="isLoggingIn" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span x-text="isLoggingIn ? 'Verifying...' : 'Sign In'"></span>
        </button>

        <p x-show="loginError" class="text-red-500 text-sm text-center font-medium animate-pulse" x-text="loginError">
        </p>
      </form>
    </div>
  </div>

  <script>
    function app() {
      return {
        isDark: false,
        isLoggedIn: false, // DEFAULT FALSE
        isLoggingIn: false,
        loginError: null,
        loginForm: {
          email: '',
          password: ''
        },
        isLoading: false,
        userEmail: '',
        stats: {
          processedCount: 0,
          totalValue: 0
        },
        queue: [],
        processingFile: null,
        history: [],
        csvResults: [],

        init() {
          // 1. Dark Mode
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            this.isDark = true;
          }

          // 2. CHECK LOCAL STORAGE FOR SESSION
          const savedEmail = localStorage.getItem('APIR_UserEmail');
          if (savedEmail) {
            this.userEmail = savedEmail;
            this.isLoggedIn = true;
            this.loadUserData(); // Restore data
          }
        },

        toggleTheme() {
          this.isDark = !this.isDark;
        },

        // LOGIN LOGIC
        login() {
          this.isLoggingIn = true;
          this.loginError = null;

          google.script.run
            .withSuccessHandler((res) => {
              this.isLoggingIn = false;
              if (res.success) {
                // Success!
                this.isLoggedIn = true;
                this.userEmail = res.email;
                localStorage.setItem('APIR_UserEmail', res.email);
                this.loadUserData(); // Load their workspace
              } else {
                this.loginError = res.error;
              }
            })
            .login(this.loginForm.email.trim().toLowerCase(), this.loginForm.password);
        },

        logout() {
          localStorage.removeItem('APIR_UserEmail');
          this.isLoggedIn = false;
          this.userEmail = '';
          this.history = [];
          this.csvResults = [];
          this.stats = { processedCount: 0, totalValue: 0 };
          this.loginForm.password = ''; // Clear password
        },

        loadUserData() {
          google.script.run
            .withSuccessHandler((res) => {
              if (res.success) {
                // Reset state to prevent double counting
                this.history = [];
                this.csvResults = [];
                this.stats = { processedCount: 0, totalValue: 0 };

                if (res.history) {
                  // DEBUG TOAST
                  const count = res.history.length;
                  if (count > 0) {
                    Swal.fire({
                      toast: true,
                      position: 'top-end',
                      icon: 'success',
                      title: `Restored ${count} invoices from history`,
                      timer: 3000,
                      showConfirmButton: false
                    });
                  } else {
                    console.log("History array is empty");
                  }

                  res.history.forEach(item => {
                    this.addToHistory(item);
                    this.addToCSVTable(item);
                  });
                }
              }
            })
            .getUserData(this.userEmail);
        },

        // Actions
        clearData() {
          // ... (Existing Clear Logic) ...
          google.script.run
            .withSuccessHandler((res) => {
              this.isLoading = false;
              if (res.success) {
                this.history = [];
                this.csvResults = [];
                this.stats.processedCount = 0;
                this.stats.totalValue = 0;
                Swal.fire('Deleted!', 'Your workspace has been reset.', 'success');
              } else {
                this.handleError(res.error);
              }
            })
            .clearUserWorkspace(this.userEmail); // PASS EMAIL
          // ...
        },

        downloadCSV() {
          // ... (Existing Logic Unchanged) ...
          if (this.csvResults.length === 0) return;
          const headers = Object.keys(this.csvResults[0]).join(",");
          const rows = this.csvResults.map(row =>
            Object.values(row).map(val => `"${val}"`).join(",")
          );
          const csvContent = [headers, ...rows].join("\n");
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", `invoices_export_${new Date().toISOString().slice(0, 10)}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },

        // ... (Existing Helpers) ...

        handleFileSelect(e) {
          const files = e.target.files;
          if (files.length > 0) {
            Array.from(files).forEach(file => {
              this.queue.push(file);
            });
            e.target.value = '';
          }
        },

        startProcessing() {
          if (!this.isLoading && this.queue.length > 0) {
            this.processQueue();
          }
        },

        processQueue() {
          if (this.queue.length === 0) {
            this.isLoading = false;
            this.processingFile = null;
            return;
          }

          this.isLoading = true;
          const file = this.queue[0];
          this.processingFile = file.name;

          const reader = new FileReader();
          reader.onload = (e) => {
            const rawBase64 = e.target.result.split(',')[1];
            google.script.run
              .withSuccessHandler((res) => {
                if (res.success) {
                  const invoices = Array.isArray(res.data) ? res.data : [res.data];
                  invoices.forEach(invoice => {
                    this.addToHistory(invoice);
                    this.addToCSVTable(invoice);
                  });
                  this.queue.shift();
                  this.processQueue();

                } else {
                  this.handleError(res.error);
                }
              })
              .withFailureHandler((err) => {
                this.handleError(err.message);
              })
              .processInvoiceUpload(rawBase64, file.name, file.type, this.userEmail); // PASS EMAIL
          };
          reader.readAsDataURL(file);
        },

        handleError(msg) {
          Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'error',
            title: 'Error Processing ' + (this.processingFile || 'File'),
            text: msg,
            timer: 3000,
            showConfirmButton: false,
            background: this.isDark ? '#1e293b' : '#fff',
            color: this.isDark ? '#fff' : '#000'
          });
          this.queue.shift();
          this.processQueue();
        },

        addToHistory(data) {
          const total = data.total_amount || 0;
          this.history.unshift({
            id: Date.now() + Math.random(),
            time: new Date(data.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            vendor: data.vendor_name || 'Unknown',
            total: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(total),
            itemsCount: (data.line_items || []).length
          });
          this.stats.processedCount++;
          this.stats.totalValue += Number(total);
        },

        addToCSVTable(data) {
          const common = {
            vendor: data.vendor_name,
            inv_num: data.invoice_number,
            date: data.invoice_date,
            due: data.due_date,
            tax: data.tax_amount,
            total: data.total_amount,
            curr: data.currency
          };
          if (data.line_items && data.line_items.length > 0) {
            data.line_items.forEach(item => {
              this.csvResults.push({ ...common, ...item });
            });
          } else {
            this.csvResults.push({ ...common, description: '', quantity: '', unit_price: '', amount: '' });
          }
        }
      }
    }
  </script>
</body>

</html>